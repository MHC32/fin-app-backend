// src/routes/transactions.js - Routes transactions FinApp Haiti
const express = require('express');
const rateLimit = require('express-rate-limit');

// Import controllers et middleware
const transactionController = require('../controllers/transactionController');
const { 
  authenticate,
  requireRole,
  generalAuthLimiter,
  adminLimiter
} = require('../middleware/auth');

// ‚úÖ NOUVEAU : Import validation centralis√©e
const { validate, validateObjectId } = require('../middleware/validation');

const router = express.Router();

/**
 * Routes transactions FinApp Haiti
 * 
 * Structure :
 * - Routes CRUD (auth requis) : cr√©ation, liste, modification, suppression
 * - Routes analytics (auth requis) : statistiques, recherche
 * - Routes actions sp√©ciales : duplication, confirmation, re√ßus, localisation
 * - Routes admin (admin uniquement) : statistiques globales
 * 
 * S√©curit√© :
 * - Authentification obligatoire pour toutes les routes
 * - Rate limiting adapt√© par type d'op√©ration
 * - Validation Joi centralis√©e (validation.js) ‚úÖ
 * - Ownership automatique (req.user.userId)
 */

// ===================================================================
// RATE LIMITING SP√âCIALIS√â POUR TRANSACTIONS
// ===================================================================

/**
 * Rate limiter pour op√©rations transaction normales
 */
const transactionOperationsLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 100, // 100 op√©rations par utilisateur par fen√™tre
  message: {
    success: false,
    message: 'Trop d\'op√©rations sur les transactions. R√©essayez dans 15 minutes.',
    error: 'transaction_operations_rate_limit_exceeded',
    retryAfter: '15 minutes'
  },
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => req.user?.userId || req.ip
});

/**
 * Rate limiter pour cr√©ation de transactions (plus restrictif)
 */
const transactionCreationLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 heure
  max: 50, // 50 cr√©ations par utilisateur par heure
  message: {
    success: false,
    message: 'Trop de cr√©ations de transactions. R√©essayez dans 1 heure.',
    error: 'transaction_creation_rate_limit_exceeded',
    retryAfter: '1 hour'
  },
  keyGenerator: (req) => req.user?.userId || req.ip
});

/**
 * Rate limiter pour analytics (mod√©r√©)
 */
const analyticsLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 heure
  max: 200, // 200 requ√™tes analytics par utilisateur par heure
  message: {
    success: false,
    message: 'Trop de requ√™tes analytics. R√©essayez dans 1 heure.',
    error: 'analytics_rate_limit_exceeded',
    retryAfter: '1 hour'
  },
  keyGenerator: (req) => req.user?.userId || req.ip
});

/**
 * Rate limiter pour recherche (l√©ger)
 */
const searchLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 60, // 60 recherches par utilisateur par fen√™tre
  message: {
    success: false,
    message: 'Trop de recherches. R√©essayez dans 15 minutes.',
    error: 'search_rate_limit_exceeded',
    retryAfter: '15 minutes'
  },
  keyGenerator: (req) => req.user?.userId || req.ip
});

// ===================================================================
// ROUTES CRUD TRANSACTIONS
// ===================================================================

/**
 * @route   POST /api/transactions
 * @desc    Cr√©er une nouvelle transaction
 * @access  Private
 */
router.post('/',
  authenticate,
  transactionCreationLimiter,
  transactionOperationsLimiter,
  validate('transaction', 'create'), // ‚úÖ Validation centralis√©e
  transactionController.createTransaction
);

/**
 * @route   GET /api/transactions/list
 * @desc    Lister toutes les transactions de l'utilisateur
 * @access  Private
 */
router.get('/list',
  authenticate,
  transactionOperationsLimiter,
  validate('transaction', 'filter', 'query'), // ‚úÖ Validation centralis√©e
  transactionController.getUserTransactions
);

/**
 * @route   GET /api/transactions/:transactionId
 * @desc    Obtenir d√©tails d'une transaction sp√©cifique
 * @access  Private
 */
router.get('/:transactionId',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  transactionController.getTransactionById
);

/**
 * @route   PUT /api/transactions/:transactionId
 * @desc    Mettre √† jour une transaction
 * @access  Private
 */
router.put('/:transactionId',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  validate('transaction', 'update'), // ‚úÖ Validation centralis√©e
  transactionController.updateTransaction
);

/**
 * @route   DELETE /api/transactions/:transactionId
 * @desc    Supprimer une transaction
 * @access  Private
 */
router.delete('/:transactionId',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  transactionController.deleteTransaction
);

// ===================================================================
// ROUTES ANALYTICS & STATISTICS
// ===================================================================

/**
 * @route   GET /api/transactions/analytics/categories
 * @desc    Analytics des transactions par cat√©gorie
 * @access  Private
 */
router.get('/analytics/categories',
  authenticate,
  analyticsLimiter,
  validate('transaction', 'analytics', 'query'), // ‚úÖ Validation centralis√©e
  transactionController.getCategoryAnalytics
);

/**
 * @route   GET /api/transactions/analytics/monthly
 * @desc    Statistiques mensuelles des transactions
 * @access  Private
 */
router.get('/analytics/monthly',
  authenticate,
  analyticsLimiter,
  validate('transaction', 'monthlyStats', 'query'), // ‚úÖ Validation centralis√©e
  transactionController.getMonthlyStats
);

/**
 * @route   GET /api/transactions/search
 * @desc    Recherche avanc√©e dans les transactions
 * @access  Private
 */
router.get('/search',
  authenticate,
  searchLimiter,
  validate('transaction', 'search', 'query'), // ‚úÖ Validation centralis√©e
  transactionController.searchTransactions
);

// ===================================================================
// ROUTES ACTIONS SP√âCIALES
// ===================================================================

/**
 * @route   POST /api/transactions/:transactionId/duplicate
 * @desc    Dupliquer une transaction existante
 * @access  Private
 */
router.post('/:transactionId/duplicate',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  validate('transaction', 'duplicate'), // ‚úÖ Validation centralis√©e
  transactionController.duplicateTransaction
);

/**
 * @route   PUT /api/transactions/:transactionId/confirm
 * @desc    Confirmer une transaction en attente
 * @access  Private
 */
router.put('/:transactionId/confirm',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  transactionController.confirmTransaction
);

/**
 * @route   POST /api/transactions/:transactionId/receipt
 * @desc    Ajouter un re√ßu √† une transaction
 * @access  Private
 */
router.post('/:transactionId/receipt',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  validate('transaction', 'addReceipt'), // ‚úÖ Validation centralis√©e
  transactionController.addReceipt
);

/**
 * @route   PUT /api/transactions/:transactionId/location
 * @desc    Ajouter/modifier la localisation d'une transaction
 * @access  Private
 */
router.put('/:transactionId/location',
  authenticate,
  transactionOperationsLimiter,
  validateObjectId('transactionId'), // ‚úÖ Validation ID
  validate('transaction', 'addLocation'), // ‚úÖ Validation centralis√©e
  transactionController.addLocation
);

// ===================================================================
// ROUTES UTILITAIRES
// ===================================================================

/**
 * @route   GET /api/transactions/suggestions
 * @desc    Obtenir suggestions de transactions bas√©es sur l'historique
 * @access  Private
 */
router.get('/suggestions',
  authenticate,
  transactionOperationsLimiter,
  validate('transaction', 'suggestions', 'query'), // ‚úÖ Validation centralis√©e
  transactionController.getTransactionSuggestions
);

// ===================================================================
// ROUTES ADMIN
// ===================================================================

/**
 * @route   GET /api/transactions/admin/stats
 * @desc    Statistiques globales des transactions (admin)
 * @access  Private (admin uniquement)
 */
router.get('/admin/stats',
  authenticate,
  requireRole('admin'),
  adminLimiter,
  transactionController.getTransactionsStats
);

// ===================================================================
// ROUTE INFO & DOCUMENTATION
// ===================================================================

/**
 * @route   GET /api/transactions
 * @desc    Information sur les endpoints transactions disponibles
 * @access  Public
 */
router.get('/', (req, res) => {
  res.json({
    success: true,
    message: 'API Transactions FinApp Haiti üí∞',
    data: {
      service: 'transactions',
      version: '1.0.0',
      description: 'Gestion compl√®te des transactions financi√®res ha√Øtiennes',
      endpoints: {
        crud: {
          create: 'POST /api/transactions',
          list: 'GET /api/transactions/list',
          getById: 'GET /api/transactions/:transactionId',
          update: 'PUT /api/transactions/:transactionId',
          delete: 'DELETE /api/transactions/:transactionId'
        },
        analytics: {
          categories: 'GET /api/transactions/analytics/categories',
          monthly: 'GET /api/transactions/analytics/monthly',
          search: 'GET /api/transactions/search'
        },
        actions: {
          duplicate: 'POST /api/transactions/:transactionId/duplicate',
          confirm: 'PUT /api/transactions/:transactionId/confirm',
          addReceipt: 'POST /api/transactions/:transactionId/receipt',
          addLocation: 'PUT /api/transactions/:transactionId/location'
        },
        utilities: {
          suggestions: 'GET /api/transactions/suggestions'
        },
        admin: {
          stats: 'GET /api/transactions/admin/stats'
        }
      },
      rateLimits: {
        operations: '100 / 15 minutes',
        creation: '50 / 1 hour',
        analytics: '200 / 1 hour',
        search: '60 / 15 minutes'
      },
      supportedTypes: ['income', 'expense', 'transfer'],
      supportedCategories: [
        'salary', 'business', 'investment', 'gift', 'other_income',
        'food', 'transport', 'housing', 'utilities', 'health', 'education',
        'entertainment', 'shopping', 'debt_payment', 'savings', 'other_expense'
      ],
      supportedCurrencies: ['HTG', 'USD'],
      security: {
        authentication: 'JWT required',
        ownership: 'Automatic user isolation',
        validation: 'Joi centralized validation', // ‚úÖ Mise √† jour
        rateLimit: 'Operation-based limiting'
      }
    },
    timestamp: new Date().toISOString()
  });
});

// ===================================================================
// EXPORTS
// ===================================================================
module.exports = router;