// src/routes/accounts.js - Routes comptes bancaires FinApp Haiti
const express = require('express');
const rateLimit = require('express-rate-limit');

// Import controllers et middleware
const accountController = require('../controllers/accountController');
const { 
  authenticate,
  requireRole,
  generalAuthLimiter,
  adminLimiter
} = require('../middleware/auth');

// âœ… NOUVEAU : Import validation centralisÃ©e
const { validate, validateObjectId } = require('../middleware/validation');

const router = express.Router();

/**
 * Routes comptes bancaires FinApp Haiti
 * 
 * Structure :
 * - Routes CRUD (auth requis) : crÃ©ation, liste, modification, suppression
 * - Routes gestion solde : ajustement, consultation
 * - Routes gestion : archivage, compte par dÃ©faut
 * - Routes utilitaires : validation banque, rÃ©sumÃ©
 * - Routes admin : comptes par utilisateur
 * 
 * SÃ©curitÃ© :
 * - Authentification obligatoire pour toutes les routes
 * - Rate limiting adaptÃ© par type d'opÃ©ration
 * - Validation Joi centralisÃ©e (validation.js) âœ…
 * - Ownership automatique (req.user.userId)
 */

// ===================================================================
// RATE LIMITING SPÃ‰CIALISÃ‰ POUR ACCOUNTS
// ===================================================================

/**
 * Rate limiter pour opÃ©rations compte normales
 */
const accountOperationsLimiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15 minutes
  max: 30, // 30 opÃ©rations par utilisateur par fenÃªtre
  message: {
    success: false,
    message: 'Trop d\'opÃ©rations sur les comptes. RÃ©essayez dans 15 minutes.',
    error: 'account_operations_rate_limit_exceeded',
    retryAfter: '15 minutes'
  },
  standardHeaders: true,
  legacyHeaders: false,
  keyGenerator: (req) => req.user?.userId || req.ip
});

/**
 * Rate limiter pour crÃ©ation de comptes (plus restrictif)
 */
const accountCreationLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 heure
  max: 5, // 5 crÃ©ations par utilisateur par heure
  message: {
    success: false,
    message: 'Trop de crÃ©ations de comptes. RÃ©essayez dans 1 heure.',
    error: 'account_creation_rate_limit_exceeded',
    retryAfter: '1 hour'
  },
  keyGenerator: (req) => req.user?.userId || req.ip
});

/**
 * Rate limiter pour ajustements de solde (trÃ¨s restrictif)
 */
const balanceAdjustmentLimiter = rateLimit({
  windowMs: 60 * 60 * 1000, // 1 heure
  max: 10, // 10 ajustements par utilisateur par heure
  message: {
    success: false,
    message: 'Trop d\'ajustements de solde. RÃ©essayez dans 1 heure.',
    error: 'balance_adjustment_rate_limit_exceeded',
    retryAfter: '1 hour'
  },
  keyGenerator: (req) => req.user?.userId || req.ip
});

// ===================================================================
// ROUTES CRUD COMPTES
// ===================================================================

/**
 * @route   POST /api/accounts
 * @desc    CrÃ©er nouveau compte
 * @access  Private
 */
router.post('/',
  authenticate,
  accountCreationLimiter,
  validate('account', 'create'), // âœ… Validation centralisÃ©e
  accountController.createAccount
);

/**
 * @route   GET /api/accounts
 * @desc    RÃ©cupÃ©rer tous les comptes utilisateur
 * @access  Private
 */
router.get('/',
  authenticate,
  generalAuthLimiter,
  validate('account', 'filter', 'query'), // âœ… Validation centralisÃ©e
  accountController.getAccounts
);

/**
 * @route   GET /api/accounts/:accountId
 * @desc    RÃ©cupÃ©rer compte spÃ©cifique
 * @access  Private
 */
router.get('/:accountId',
  authenticate,
  generalAuthLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  accountController.getAccountById
);

/**
 * @route   PUT /api/accounts/:accountId
 * @desc    Mettre Ã  jour compte
 * @access  Private
 */
router.put('/:accountId',
  authenticate,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  validate('account', 'update'), // âœ… Validation centralisÃ©e
  accountController.updateAccount
);

/**
 * @route   DELETE /api/accounts/:accountId
 * @desc    Supprimer/dÃ©sactiver compte
 * @access  Private
 */
router.delete('/:accountId',
  authenticate,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  accountController.deleteAccount
);

// ===================================================================
// ROUTES GESTION SOLDE
// ===================================================================

/**
 * @route   PUT /api/accounts/:accountId/adjust-balance
 * @desc    Ajuster manuellement le solde d'un compte
 * @access  Private
 */
router.put('/:accountId/adjust-balance',
  authenticate,
  balanceAdjustmentLimiter,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  validate('account', 'adjustBalance'), // âœ… Validation centralisÃ©e
  accountController.adjustBalance
);

/**
 * @route   POST /api/accounts/:accountId/transfer
 * @desc    TransfÃ©rer entre comptes
 * @access  Private
 */
router.post('/:accountId/transfer',
  authenticate,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  validate('account', 'transfer'), // âœ… Validation centralisÃ©e
  accountController.transferBetweenAccounts
);

// ===================================================================
// ROUTES GESTION COMPTES
// ===================================================================

/**
 * @route   PUT /api/accounts/:accountId/set-default
 * @desc    DÃ©finir un compte comme compte par dÃ©faut
 * @access  Private
 */
router.put('/:accountId/set-default',
  authenticate,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  accountController.setDefaultAccount
);

/**
 * @route   PUT /api/accounts/:accountId/archive
 * @desc    Archiver un compte
 * @access  Private
 */
router.put('/:accountId/archive',
  authenticate,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  validate('account', 'archive'), // âœ… Validation centralisÃ©e
  accountController.archiveAccount
);

/**
 * @route   PUT /api/accounts/:accountId/unarchive
 * @desc    DÃ©sarchiver un compte
 * @access  Private
 */
router.put('/:accountId/unarchive',
  authenticate,
  accountOperationsLimiter,
  validateObjectId('accountId'), // âœ… Validation ID
  accountController.unarchiveAccount
);

// ===================================================================
// ROUTES UTILITAIRES & RÃ‰SUMÃ‰
// ===================================================================

/**
 * @route   GET /api/accounts/summary/all
 * @desc    RÃ©sumÃ© de tous les comptes
 * @access  Private
 */
router.get('/summary/all',
  authenticate,
  generalAuthLimiter,
  accountController.getAccountsSummary
);

/**
 * @route   GET /api/accounts/validate/bank/:bankCode
 * @desc    Valider un code banque haÃ¯tienne
 * @access  Private
 */
router.get('/validate/bank/:bankCode',
  authenticate,
  generalAuthLimiter,
  accountController.validateBankCode
);

// ===================================================================
// ROUTES ADMIN
// ===================================================================

/**
 * @route   GET /api/accounts/admin/users/:userId/accounts
 * @desc    Comptes d'un utilisateur (admin)
 * @access  Private (admin uniquement)
 */
router.get('/admin/users/:userId/accounts',
  authenticate,
  requireRole('admin'),
  adminLimiter,
  validateObjectId('userId'), // âœ… Validation ID
  accountController.getUserAccountsAdmin
);

// ===================================================================
// ROUTE INFO & DOCUMENTATION
// ===================================================================

/**
 * @route   GET /api/accounts
 * @desc    Information sur les endpoints comptes disponibles
 * @access  Private
 */
router.get('/info',
  authenticate,
  generalAuthLimiter,
  (req, res) => {
    res.status(200).json({
      success: true,
      message: 'Service comptes bancaires FinApp Haiti ðŸ‡­ðŸ‡¹',
      data: {
        service: 'accounts',
        version: '1.0.0',
        description: 'Gestion complÃ¨te des comptes bancaires HTG/USD',
        endpoints: {
          crud: {
            create: 'POST /api/accounts',
            list: 'GET /api/accounts',
            getById: 'GET /api/accounts/:accountId',
            update: 'PUT /api/accounts/:accountId',
            delete: 'DELETE /api/accounts/:accountId'
          },
          balance: {
            adjust: 'PUT /api/accounts/:accountId/adjust-balance',
            transfer: 'POST /api/accounts/:accountId/transfer'
          },
          management: {
            setDefault: 'PUT /api/accounts/:accountId/set-default',
            archive: 'PUT /api/accounts/:accountId/archive',
            unarchive: 'PUT /api/accounts/:accountId/unarchive'
          },
          utilities: {
            summary: 'GET /api/accounts/summary/all',
            validateBank: 'GET /api/accounts/validate/bank/:bankCode'
          },
          admin: {
            userAccounts: 'GET /api/accounts/admin/users/:userId/accounts'
          }
        },
        rateLimits: {
          operations: '30 / 15 minutes',
          creation: '5 / 1 hour',
          balanceAdjustment: '10 / 1 hour'
        },
        security: {
          authentication: 'JWT required',
          ownership: 'Automatic user isolation',
          validation: 'Joi centralized validation', // âœ… Mise Ã  jour
          rateLimit: 'Operation-based limiting'
        },
        supportedBanks: [
          'BRH', 'BUH', 'SOGEBANK', 'CAPITAL_BANK', 'UNIBANK',
          'BNC', 'SCOTIABANK', 'CITIBANK', 'BPH'
        ],
        currencies: ['HTG', 'USD']
      },
      timestamp: new Date().toISOString()
    });
  }
);

// ===================================================================
// EXPORTS
// ===================================================================
module.exports = router;